// --- 1. The Story Database (Where you add new stories) ---
const stories = [
    {
        id: 'eli-the-elephant',
        title: "Eli the Honest Elephant",
        cover: "coverpage.jpg",
        theme: "Honesty & Truth",
        moral: "Honesty is always the best policy; telling the truth frees you from guilt and builds trust with those you love.",
        pages: [
            {
                text: "Eli the little elephant loved peanuts, but today he promised his mama he wouldn't eat any before dinner.",
                image: "page1.jpg"
            },
            {
                text: "When Mama asked if he ate the peanuts, Eli shook his head and said, 'No, a mischievous monkey must have taken them!'",
                image: "page2.jpg"
            },
            {
                text: "Later, his tummy started to rumble and grumble really loud because he had eaten too many peanuts.",
                image: "page3.jpg"
            },
            {
                text: "Eli couldn't handle the tummy ache any longer, so he found his mama and told her the truth about eating the peanuts.",
                image: "page4.jpg"
            },
            {
                text: "Mama hugged Eli and gave him some special leaves for his tummy, telling him that telling the truth always makes everything better.",
                image: "page5.jpg"
            }
        ]
    }
];

// --- 2. Country Info Data ---
const countryData = {
    'en': { flag: 'ðŸ‡ºðŸ‡¸ / ðŸ‡¬ðŸ‡§', animal: 'Eagle / Lion' },
    'si': { flag: 'ðŸ‡±ðŸ‡°', animal: 'Jungle Fowl' },
    'hi': { flag: 'ðŸ‡®ðŸ‡³', animal: 'Bengal Tiger' },
    'es': { flag: 'ðŸ‡ªðŸ‡¸', animal: 'Bull' },
    'fr': { flag: 'ðŸ‡«ðŸ‡·', animal: 'Gallic Rooster' },
    'zh-CN': { flag: 'ðŸ‡¨ðŸ‡³', animal: 'Giant Panda' }
};

// --- Variables ---
let currentStory = null;
let currentPageIndex = 0;
let isAnimating = false;
const appContainer = document.getElementById('app-container');

// --- Functions ---

// 1. Render the Library (Home Page)
function renderLibrary() {
    let html = `
        <div class="library-hero">
            <h2 class="library-title">Magical Library</h2>
            <p class="library-subtitle">Choose a story and start your adventure!</p>
        </div>
        <div class="story-grid">
    `;

    stories.forEach(story => {
        html += `
            <div class="story-card" onclick="openStory('${story.id}')">
                <div class="card-image-container">
                    <img src="${story.cover}" alt="${story.title}" class="story-cover">
                    <div class="card-badge">${story.theme}</div>
                </div>
                <div class="card-content">
                    <h2>${story.title}</h2>
                    <button class="read-btn"><i class="fas fa-magic"></i> Open Book</button>
                </div>
            </div>
        `;
    });

    html += `
        </div>
        <div class="adsense-placeholder">
            <small>ADVERTISEMENT</small>
            <br> [ Google AdSense Display Banner ]
        </div>
    `;

    appContainer.innerHTML = html;
}

// 2. Open a Story
window.openStory = function(storyId) {
    currentStory = stories.find(s => s.id === storyId);
    currentPageIndex = 0;
    renderStoryPage();
};

// 3. Render a Specific Page with Book Animation
function renderStoryPage() {
    if (!currentStory) return;

    const isEndPage = currentPageIndex === currentStory.pages.length;

    let html = `
        <div class="reader-header">
            <button onclick="closeStory()" class="back-btn">
                <i class="fas fa-times"></i> Exit
            </button>
            <div class="page-counter">Step ${currentPageIndex + 1} of ${currentStory.pages.length + 1}</div>
        </div>
    `;

    if (isEndPage) {
        html += `
            <div class="book-frame animate-in">
                <div class="end-screen">
                    <div class="magic-sparkles"></div>
                    <i class="fas fa-certificate end-medal"></i>
                    <h2 class="end-title notranslate">The Golden End</h2>
                    <div class="moral-container">
                        <h3><i class="fas fa-star"></i> Wisdom Earned</h3>
                        <p class="moral-big-text">"${currentStory.moral}"</p>
                    </div>
                    <div class="reward-box">
                        <p>You've completed the story!</p>
                        <button class="download-btn"><i class="fas fa-cloud-download-alt"></i> Get Memory PDF ($1)</button>
                    </div>
                </div>
            </div>
        `;
    } else {
        const pageData = currentStory.pages[currentPageIndex];
        html += `
            <div class="book-frame ${isAnimating ? 'turning' : 'animate-in'}">
                <div class="book-spine"></div>
                <div class="book-page left-page">
                    <div class="page-content">
                        <button class="speak-btn" onclick="readAloud()" title="Listen to Story">
                            <i class="fas fa-volume-up"></i>
                        </button>
                        <p class="story-text-display">${pageData.text}</p>
                    </div>
                    <div class="page-number">${(currentPageIndex * 2) + 1}</div>
                </div>
                <div class="book-page right-page">
                    <div class="image-wrapper">
                        <img src="${pageData.image}" alt="Eli Scene" class="story-img-main">
                        <div class="img-overlay"></div>
                    </div>
                    <div class="page-number">${(currentPageIndex * 2) + 2}</div>
                </div>
            </div>
        `;
    }

    // Modern Navigation Controls
    html += `
        <div class="navigation-bar">
            <button class="nav-control prev" onclick="turnPage(-1)" ${currentPageIndex === 0 ? 'disabled' : ''}>
                <i class="fas fa-arrow-left"></i> Previous
            </button>
            <div class="nav-indicator">
                ${currentStory.pages.map((_, i) => `<div class="dot ${i === currentPageIndex ? 'active' : ''}"></div>`).join('')}
                <div class="dot ${isEndPage ? 'active' : ''}"></div>
            </div>
            <button class="nav-control next" onclick="turnPage(1)" ${isEndPage ? 'disabled' : ''}>
                ${isEndPage ? 'Finished' : 'Next <i class="fas fa-arrow-right"></i>'}
            </button>
        </div>
    `;

    appContainer.innerHTML = html;
}

// 4. Turn Page with Simulated Scrolling/Flipping
window.turnPage = function(direction) {
    if (isAnimating) return;
    
    const newPage = currentPageIndex + direction;
    if (newPage >= 0 && newPage <= currentStory.pages.length) {
        isAnimating = true;
        
        // Render with turning class
        renderStoryPage();
        
        setTimeout(() => {
            currentPageIndex = newPage;
            isAnimating = false;
            renderStoryPage();
        }, 600); // Wait for transition
    }
};

// 5. Close Story
window.closeStory = function() {
    currentStory = null;
    renderLibrary();
};

// 6. Read Aloud (Enhanced)
window.readAloud = function() {
    if (!currentStory || currentPageIndex >= currentStory.pages.length) return;
    const textToRead = currentStory.pages[currentPageIndex].text;
    
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(textToRead);
        utterance.lang = document.documentElement.lang || 'en';
        utterance.pitch = 1.1; // Kid-friendly high pitch
        utterance.rate = 0.9;  // Slightly slower for better understanding
        window.speechSynthesis.speak(utterance);
    }
};

// 7. Watch for Language Changes
setInterval(() => {
    const infoDiv = document.getElementById('country-info');
    if(!infoDiv) return;
    const selectBox = document.querySelector('.goog-te-combo');
    if (selectBox && selectBox.value) {
        const currentLangCode = selectBox.value;
        if (countryData[currentLangCode]) {
            const data = countryData[currentLangCode];
            infoDiv.innerHTML = `<span class="flag-icon">${data.flag}</span> Reading in <strong>${currentLangCode.toUpperCase()}</strong> | National Animal: <strong>${data.animal}</strong>`;
        }
    }
}, 2000);

// --- Initialize App ---
renderLibrary();